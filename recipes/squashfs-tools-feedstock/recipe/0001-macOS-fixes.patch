From c42b4e5a86a4fee47672d7c338709e854ae02a7d Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sat, 13 Jul 2019 01:30:48 +0200
Subject: [PATCH] macOS fixes

---
 squashfs-tools/macosx.h           | 23 +++++++++++++++++++++++
 squashfs-tools/mksquashfs.c       |  7 +++++++
 squashfs-tools/unsquashfs.c       |  4 ++++
 squashfs-tools/unsquashfs_xattr.c |  1 +
 squashfs-tools/xattr.c            |  2 ++
 5 files changed, 37 insertions(+)
 create mode 100644 squashfs-tools/macosx.h

diff --git a/squashfs-tools/macosx.h b/squashfs-tools/macosx.h
new file mode 100644
index 0000000..d6038b6
--- /dev/null
+++ b/squashfs-tools/macosx.h
@@ -0,0 +1,23 @@
+#ifndef SQUASHFS_MACOSX
+#define SQUASHFS_MACOSX 1
+
+// MAC OS X specific defines
+
+#ifndef FNM_EXTMATCH
+#define FNM_EXTMATCH   0
+#endif
+
+#define strdupa(s)   strdup(s)
+
+// do not track info (because of sigtimedwait/sigwaitinfo)
+#define SQUASHFS_DISABLE_INFO  1
+#define disable_info()
+#define update_info(arg)
+#define init_info()
+
+// extended attribute manipulation
+#define llistxattr(path, buf, size)   listxattr((path), (buf), (size), XATTR_NOFOLLOW)
+#define lgetxattr(path, name, value, size)   getxattr((path), (name), (value), (size), 0, XATTR_NOFOLLOW)
+#define lsetxattr(path, name, value, size, flags)   setxattr((path), (name), (value), (size), 0, (flags) | XATTR_NOFOLLOW)
+
+#endif
\ No newline at end of file
diff --git a/squashfs-tools/mksquashfs.c b/squashfs-tools/mksquashfs.c
index 69d324e..24cabdd 100644
--- a/squashfs-tools/mksquashfs.c
+++ b/squashfs-tools/mksquashfs.c
@@ -5191,7 +5191,14 @@ int get_physical_memory()
 	 * sysconf(_SC_PHYS_PAGES) relies on /proc being mounted.
 	 * If it fails use sysinfo, if that fails return 0
 	 */
+#if defined(__APPLE__)
+	long long num_pages;
+	size_t len = sizeof(num_pages);
+	sysctlbyname("hw.memsize", &num_pages, &len, NULL, 0);
+        num_pages /= sysconf(_SC_PAGE_SIZE);
+#else
 	long long num_pages = sysconf(_SC_PHYS_PAGES);
+#endif
 	long long page_size = sysconf(_SC_PAGESIZE);
 	int phys_mem;
 
diff --git a/squashfs-tools/unsquashfs.c b/squashfs-tools/unsquashfs.c
index 68e6742..7a1b791 100644
--- a/squashfs-tools/unsquashfs.c
+++ b/squashfs-tools/unsquashfs.c
@@ -1079,10 +1079,12 @@ int create_inode(char *pathname, struct inode *i)
 			break;
 		case SQUASHFS_SYMLINK_TYPE:
 		case SQUASHFS_LSYMLINK_TYPE: {
+#if !defined(__APPLE__) || (MAC_OS_X_VERSION_MIN_REQUIRED >= 101300)
 			struct timespec times[2] = {
 				{ i->time, 0 },
 				{ i->time, 0 }
 			};
+#endif
 
 			TRACE("create_inode: symlink, symlink_size %lld\n",
 				i->data);
@@ -1098,6 +1100,7 @@ int create_inode(char *pathname, struct inode *i)
 				goto failed;
 			}
 
+if !defined(__APPLE__) || (MAC_OS_X_VERSION_MIN_REQUIRED >= 101300)
 			res = utimensat(AT_FDCWD, pathname, times,
 					AT_SYMLINK_NOFOLLOW);
 			if(res == -1) {
@@ -1105,6 +1108,7 @@ int create_inode(char *pathname, struct inode *i)
 					"%s, because %s\n", pathname,
 					strerror(errno));
 			}
+#endif
 
 			res = write_xattr(pathname, i->xattr);
 			if(res == FALSE)
diff --git a/squashfs-tools/unsquashfs_xattr.c b/squashfs-tools/unsquashfs_xattr.c
index 7742dfe..6978612 100644
--- a/squashfs-tools/unsquashfs_xattr.c
+++ b/squashfs-tools/unsquashfs_xattr.c
@@ -24,6 +24,7 @@
 
 #include "unsquashfs.h"
 #include "xattr.h"
+#include "macosx.h"
 
 #include <sys/xattr.h>
 
diff --git a/squashfs-tools/xattr.c b/squashfs-tools/xattr.c
index 64dfd82..f9729c2 100644
--- a/squashfs-tools/xattr.c
+++ b/squashfs-tools/xattr.c
@@ -43,6 +43,8 @@
 #include "error.h"
 #include "progressbar.h"
 
+#include "macosx.h"
+
 /* compressed xattr table */
 static char *xattr_table = NULL;
 static unsigned int xattr_size = 0;
-- 
2.20.1

