From 547e21b6428f990baf1f19c7f93232c345847101 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Thu, 22 Aug 2019 01:17:46 +0200
Subject: [PATCH 2/2] macOS fixes two

---
 squashfs-tools/info.c            | 72 +++++++++++++++++++-------------
 squashfs-tools/unsquashfs_info.c | 20 ++++++++-
 2 files changed, 62 insertions(+), 30 deletions(-)

diff --git a/squashfs-tools/info.c b/squashfs-tools/info.c
index fe23d78..00a262e 100644
--- a/squashfs-tools/info.c
+++ b/squashfs-tools/info.c
@@ -35,7 +35,9 @@
 #include <dirent.h>
 #include <sys/types.h>
 #include <sys/stat.h>
+#if !defined(__APPLE__)
 #include <string.h>
+#endif
 
 #include "squashfs_fs.h"
 #include "mksquashfs.h"
@@ -143,44 +145,56 @@ void dump_state()
 
 void *info_thrd(void *arg)
 {
+#if !defined(__APPLE__)
+       struct timespec timespec = { .tv_sec = 1, .tv_nsec = 0 };
+       int sig, waiting = 0;
+#else
 	sigset_t sigmask;
-	struct timespec timespec = { .tv_sec = 1, .tv_nsec = 0 };
-	int sig, waiting = 0;
+	int sig;
+#endif
 
 	sigemptyset(&sigmask);
 	sigaddset(&sigmask, SIGQUIT);
 	sigaddset(&sigmask, SIGHUP);
 
 	while(1) {
-		if(waiting)
-			sig = sigtimedwait(&sigmask, NULL, &timespec);
-		else
-			sig = sigwaitinfo(&sigmask, NULL);
-
-		if(sig == -1) {
-			switch(errno) {
-			case EAGAIN:
-				/* interval timed out */
-				waiting = 0;
-				/* FALLTHROUGH */
-			case EINTR:
-				/* if waiting, the wait will be longer, but
-				   that's OK */
-				continue;
-			default:
-				BAD_ERROR("sigtimedwait/sigwaitinfo failed "
-					"because %s\n", strerror(errno));
-			}
-		}
-
-		if(sig == SIGQUIT && !waiting) {
+#if !defined(__APPLE__)
+               if(waiting)
+                       sig = sigtimedwait(&sigmask, NULL, &timespec);
+               else
+                       sig = sigwaitinfo(&sigmask, NULL);
+
+               if(sig == -1) {
+                       switch(errno) {
+                       case EAGAIN:
+                               /* interval timed out */
+                               waiting = 0;
+                               /* FALLTHROUGH */
+                       case EINTR:
+                               /* if waiting, the wait will be longer, but
+                                  that's OK */
+                               continue;
+                       default:
+                               BAD_ERROR("sigtimedwait/sigwaitinfo failed "
+                                       "because %s\n", strerror(errno));
+                       }
+               }
+
+               if(sig == SIGQUIT && !waiting) {
+                       print_filename();
+
+                       /* set one second interval period, if ^\ received
+                          within then, dump queue and cache status */
+                       waiting = 1;
+               } else
+                       dump_state();
+#else
+		sigwait(&sigmask, &sig);
+		if(sig == SIGQUIT)
 			print_filename();
-
-			/* set one second interval period, if ^\ received
-			   within then, dump queue and cache status */
-			waiting = 1;
-		} else
+		else
 			dump_state();
+#endif
 	}
 }
 
diff --git a/squashfs-tools/unsquashfs_info.c b/squashfs-tools/unsquashfs_info.c
index c8e2b9b..655a226 100644
--- a/squashfs-tools/unsquashfs_info.c
+++ b/squashfs-tools/unsquashfs_info.c
@@ -93,9 +93,9 @@ void dump_state()
 	enable_progress_bar();
 }
 
-
 void *info_thrd(void *arg)
 {
+#if !defined (__APPLE__)
 	sigset_t sigmask;
 	struct timespec timespec = { .tv_sec = 1, .tv_nsec = 0 };
 	int sig, waiting = 0;
@@ -136,6 +136,24 @@ void *info_thrd(void *arg)
 		} else
 			dump_state();
 	}
+#else
+	sigset_t sigmask;
+	int sig;
+
+	sigemptyset(&sigmask);
+	sigaddset(&sigmask, SIGQUIT);
+	sigaddset(&sigmask, SIGHUP);
+
+	while(1) {
+		sigwait(&sigmask, &sig);
+
+		if(sig == SIGQUIT) {
+			if(pathname)
+				INFO("%s\n", pathname);
+		} else
+			dump_state();
+	}
+#endif
 }
 
 
-- 
2.20.1

