From 1826a94d6479412edd0828f1bddc22372020312e Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sat, 13 Jul 2019 01:30:48 +0200
Subject: [PATCH] macOS fixes

---
 squashfs-tools/macosx.h           | 23 +++++++++++++++++++++++
 squashfs-tools/mksquashfs.c       |  7 +++++++
 squashfs-tools/unsquashfs.c       |  5 +++++
 squashfs-tools/unsquashfs_xattr.c |  1 +
 squashfs-tools/xattr.c            |  2 ++
 5 files changed, 38 insertions(+)
 create mode 100644 squashfs-tools/macosx.h

diff --git a/squashfs-tools/macosx.h b/squashfs-tools/macosx.h
new file mode 100644
index 0000000..d6038b6
--- /dev/null
+++ b/squashfs-tools/macosx.h
@@ -0,0 +1,23 @@
+#ifndef SQUASHFS_MACOSX
+#define SQUASHFS_MACOSX 1
+
+// MAC OS X specific defines
+
+#ifndef FNM_EXTMATCH
+#define FNM_EXTMATCH   0
+#endif
+
+#define strdupa(s)   strdup(s)
+
+// do not track info (because of sigtimedwait/sigwaitinfo)
+#define SQUASHFS_DISABLE_INFO  1
+#define disable_info()
+#define update_info(arg)
+#define init_info()
+
+// extended attribute manipulation
+#define llistxattr(path, buf, size)   listxattr((path), (buf), (size), XATTR_NOFOLLOW)
+#define lgetxattr(path, name, value, size)   getxattr((path), (name), (value), (size), 0, XATTR_NOFOLLOW)
+#define lsetxattr(path, name, value, size, flags)   setxattr((path), (name), (value), (size), 0, (flags) | XATTR_NOFOLLOW)
+
+#endif
\ No newline at end of file
diff --git a/squashfs-tools/mksquashfs.c b/squashfs-tools/mksquashfs.c
index f1d5f42..2e208e8 100644
--- a/squashfs-tools/mksquashfs.c
+++ b/squashfs-tools/mksquashfs.c
@@ -4995,7 +4995,14 @@ int get_physical_memory()
 	 * sysconf(_SC_PHYS_PAGES) relies on /proc being mounted.
 	 * If it isn't fail.
 	 */
+#if defined(__APPLE__)
+	long long num_pages;
+	size_t len = sizeof(num_pages);
+	sysctlbyname("hw.memsize", &num_pages, &len, NULL, 0);
+        num_pages /= sysconf(_SC_PAGE_SIZE);
+#else
 	long long num_pages = sysconf(_SC_PHYS_PAGES);
+#endif
 	long long page_size = sysconf(_SC_PAGESIZE);
 	int phys_mem = num_pages * page_size >> 20;
 
diff --git a/squashfs-tools/unsquashfs.c b/squashfs-tools/unsquashfs.c
index 4d1ea38..2afc28a 100644
--- a/squashfs-tools/unsquashfs.c
+++ b/squashfs-tools/unsquashfs.c
@@ -1104,10 +1104,12 @@ int create_inode(char *pathname, struct inode *i)
 		break;
 	case SQUASHFS_SYMLINK_TYPE:
 	case SQUASHFS_LSYMLINK_TYPE: {
+#if !defined(__APPLE__) || (MAC_OS_X_VERSION_MIN_REQUIRED >= 101300)
 		struct timespec times[2] = {
 			{ i->time, 0 },
 			{ i->time, 0 }
 		};
+#endif
 
 		TRACE("create_inode: symlink, symlink_size %lld\n",
 		      i->data);
@@ -1123,12 +1125,15 @@ int create_inode(char *pathname, struct inode *i)
 			break;
 		}
 
+#if !defined(__APPLE__) || (MAC_OS_X_VERSION_MIN_REQUIRED >= 101300)
+#error good
 		if (utimensat(AT_FDCWD, pathname, times,
 				AT_SYMLINK_NOFOLLOW) == -1) {
 			ERROR("create_inode: failed to set time on "
 			      "%s, because %s\n", pathname,
 			      strerror(errno));
 		}
+#endif
 
 		write_xattr(pathname, i->xattr);
 
diff --git a/squashfs-tools/unsquashfs_xattr.c b/squashfs-tools/unsquashfs_xattr.c
index 05c68fb..8ba1b95 100644
--- a/squashfs-tools/unsquashfs_xattr.c
+++ b/squashfs-tools/unsquashfs_xattr.c
@@ -24,6 +24,7 @@
 
 #include "unsquashfs.h"
 #include "xattr.h"
+#include "macosx.h"
 
 #include <sys/xattr.h>
 
diff --git a/squashfs-tools/xattr.c b/squashfs-tools/xattr.c
index 60d5c11..ceb6ee6 100644
--- a/squashfs-tools/xattr.c
+++ b/squashfs-tools/xattr.c
@@ -43,6 +43,8 @@
 #include "error.h"
 #include "progressbar.h"
 
+#include "macosx.h"
+
 /* compressed xattr table */
 static char *xattr_table = NULL;
 static unsigned int xattr_size = 0;
-- 
2.20.1

