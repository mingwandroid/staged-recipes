{% set name = "squashfskit" %}
{% set version = "4.14" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  #- url: https://github.com/squashfskit/squashfskit/archive/v{{ version }}.tar.gz
  #  fn: {{ name }}-v{{ version }}.tar.gz
  #  sha256: 10ad288a4743a22ec69bd04bb5633b29072e4646c0062fd484e82ef247669dc7
  - git_url: https://github.com/squashfskit/squashfskit
    patches:
      - 0001-macOS-fixes.patch
      - 0002-Fix-https-github.com-squashfskit-squashfskit-issues-.patch
  - url: https://raw.githubusercontent.com/plougher/squashfs-tools/master/COPYING
    sha256: 8177f97513213526df2cf6184d8ff986c675afb514d4e68a404010521b880643


build:
  number: 0
  skip: True  # [win]


requirements:
  build:
    - {{ compiler('c') }}
  host:
    - zlib
    - xz
    - lz4-c
    - lzo
    - zstd

test:
  requires:
    # Just to check that reproducibility works.
    - openssl
  files:
    - random_binaries/
  commands:
    # --help fails
    - unsquashfs --help || true
    - mksquashfs --help || true
    # grep for the (gold) zstandard
    - unsquashfs --help 2>&1 | grep zstd
    - mksquashfs --help 2>&1 | grep zstd
    - mksquashfs random_binaries/* squashed_fs.1.img
    - mksquashfs random_binaries/* squashed_fs.2.img
    - 'SHA1=$(openssl sha1 squashed_fs.1.img | cut -d" " -f 2)'
    - 'SHA2=$(openssl sha1 squashed_fs.2.img | cut -d" " -f 2)'
    - 'echo SHA1: ${SHA1}'
    - 'echo SHA2: ${SHA2}'
    - '[[ ${SHA1} == ${SHA2} ]] || exit 1'
    - unsquashfs -d random_binaries2 squashed_fs.1.img
    - find random_binaries2
    - diff -urN random_binaries random_binaries2

about:
  # Maybe:
  # home: https://packages.debian.org/sid/squashfs-tools
  home: https://github.com/plougher/squashfs-tools
  license: GPL-2.0
  license_file: COPYING
  summary: tools to create and extract Squashfs filesystems ({Rasp,De}bian)
  description: |
    tools to create and extract Squashfs filesystems
    with Debian patches and good compression support (only LZMA unsupported)
  dev_url: https://github.com/plougher/squashfs-tools

extra:
  recipe-maintainers:
    - mingwandroid
    # I took the liberty here, @jjhelmus, let me know if you are not up for it.
    - jjhelmus
